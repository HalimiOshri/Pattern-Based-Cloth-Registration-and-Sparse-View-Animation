root_dir: /mnt/captures/chenglei/recordings/AutumnBodyGHS
codec_dir: ${root_dir}/codecTempRL

preprocessing_dir: /mnt/home/oshrihalimi/cloth_completion/data_processing/
clothes_codec_dir: ${preprocessing_dir}/clothesCodec/
kinematic_dir: /mnt/home/fabianprada/Data/SociopticonProcessing/s--20210823--1323--0000000--pilot--patternCloth/kinematic_tracking/

module_prefix: models.codec_models

#raw_sequence_dir: /mnt/captures/studies/pilots/sociopticon/Aug18/s--20210823--1323--0000000--pilot--patternCloth/
raw_sequence_dir: /mnt/home/oshrihalimi/pycharm/cloth_completion/assets/raw_sequence_dir

overwrite: False

uv_size: 1024
num_pose_dims: 98  # 104 (new format) - 6 (global transformation)
num_embs_channels: 64
noise_std: 0.05
temporal_buffer_size: 1
model:
  class_name: ${module_prefix}.pixel_cloth_codec_inhouse_pixel_projection.InhousePixelProjectionPixelCodecClothModel
  requires_dataset: True
  config:
    net:
      class_name: models.normal_nets.unet_codec.ClothGeoTexUNet
      num_input_channels: 4 # N_cam * 2 * temporal_buffer_size
      uv_size: ${uv_size}
      n_ftrs: 64
    kinematic_model:
      clothes_lbs: # DONE!
        model_json_path: ${preprocessing_dir}/clothesCodec/clothes_lbs/codec.json
        model_txt_path: ${kinematic_dir}/small_pattern/averageman_artist_v01_beta/model/averageman_v01_Body.cfg
        num_max_skin_joints: 9  # some vertices are skinned by 9 joints

split: # DONE!
  all:
    frame_list_path: /mnt/home/donglaix/Codec/CodecHand/configs/splits/patterned_cloth/all.txt

  train:
    frame_list_path: /mnt/home/donglaix/Codec/CodecHand/configs/splits/patterned_cloth/train.txt

  val:
    frame_list_path: /mnt/home/donglaix/Codec/CodecHand/configs/splits/patterned_cloth/val.txt

  test:
    frame_list_path: /mnt/home/donglaix/Codec/CodecHand/configs/splits/patterned_cloth/val.txt


dataset:
  base_dir: ${root_dir}
  temporal_buffer_size: ${temporal_buffer_size}
  # settings for uv images
  uv_size: ${uv_size}

  # global scaling?
  global_scaling: [10.,-10.,-10.]

  clothes_reference_mesh_path: /mnt/home/donglaix/s--20210823--1323--0000000--pilot--patternCloth/clothesCodec/seamlessTexture_from_ply.obj # DONE!
  clothes_reference_uv_mapping_path: /mnt/home/donglaix/s--20210823--1323--0000000--pilot--patternCloth/clothesCodec/uvmappings.txt # DONE!
  clothes_nbs_idxs_path: /mnt/home/donglaix/s--20210823--1323--0000000--pilot--patternCloth/clothesCodec/neighboridx.txt # DONE!
  clothes_nbs_weights_path: /mnt/home/donglaix/s--20210823--1323--0000000--pilot--patternCloth/clothesCodec/neighborwts.txt # DONE!
  clothes_verts_unposed_mean_path: /mnt/home/oshrihalimi/pycharm/cloth_completion/assets/clothes_unposed_mean.ply # DONE!

  # motion selection parameters
  motion_path: ${kinematic_dir}/small_pattern/averageman_artist_v01_beta/momentum/skeleton_tracking/CompactPose/pose-{frame:06d}.txt

  clothes_lbs_template_path: /mnt/home/oshrihalimi/pycharm/cloth_completion/assets/clothes_unposed_mean.ply
  clothes_lbs_scale_path: ${kinematic_dir}/small_pattern/averageman_artist_v01_beta/kinematic_alignment/body_personalization/personalized/final/scale.txt
  clothes_geometry_mesh_path: /mnt/home/fabianprada/Data/SociopticonProcessing/s--20210823--1323--0000000--pilot--patternCloth/shirt_tracking/small_pattern/surface_deformable/incremental_registration/Meshes/skinned-{frame:06d}.ply

  krt_path: /mnt/home/oshrihalimi/pycharm/cloth_completion/assets/KRTselected # krt and drivingCamsSelected should be corresponding in order and values!
  path_camera_indices: /mnt/home/oshrihalimi/pycharm/cloth_completion/assets/drivingCamsSelected.txt

  valid_cameras: /mnt/home/oshrihalimi/pycharm/cloth_completion/assets/single_cam.txt
  sample_cameras: True
  inverse_rendering: True

  # For mesh to UV conversion
  template_obj_path: /mnt/home/oshrihalimi/pycharm/cloth_completion/assets/domain_conversion_files/seamlessTextured.obj
  template_ply_path: /mnt/home/oshrihalimi/pycharm/cloth_completion/assets/domain_conversion_files/seamlessTextured.ply
  barycentric_path: /mnt/home/oshrihalimi/pycharm/cloth_completion/assets/domain_conversion_files/uvToMesh_1024/uvGrid_to_mesh_bc.bt
  tIndex_path: /mnt/home/oshrihalimi/pycharm/cloth_completion/assets/domain_conversion_files/uvToMesh_1024/uvGrid_to_mesh_tIndex.bt

  # For pixel projection
  dummy_texture_path: /mnt/home/oshrihalimi/pycharm/cloth_completion/assets/texture_cats.jpeg #dummy texture for pixel projection layer

  # image_path: ${raw_sequence_dir}/undistorted/cam{camera}/image{frame:04d}.png
  # image_part_mask_path: /mnt/captures/studies/pilots/sociopticon/Aug18/s--20210823--1323--0000000--pilot--patternCloth/experimental/segmentation_part/predictions/segmentation/cam{camera}/image{frame:04d}.png
  # per_camera_delta_pixel_uv_path: /mnt/home/oshrihalimi/cloth_completion/data_processing/delta_pixel_location_uv_detection_minus_LBS_posed_cleaned/{frame}.bt
  # posed_LBS_mesh_path: /mnt/home/oshrihalimi/cloth_completion/data_processing/posedLBS/{frame:06d}.ply
  # per_camera_delta_pixel_uv_path: /mnt/home/oshrihalimi/cloth_completion/data_processing/delta_pixel_location_uv_detection_minus_posed_bimonocular_kinematic_model_cleaned/{frame}.pt
  per_camera_delta_pixel_uv_path: /mnt/home/oshrihalimi/cloth_completion/data_processing/delta_pixel_location_uv_detection_minus_zero/{frame}.pt
  # posed_LBS_mesh_path: /mnt/home/fabianprada/Data/SociopticonProcessing/s--20210823--1323--0000000--pilot--patternCloth/shirt_tracking/small_pattern/ik_momentum/refitting_non_sequential/Meshes-03/skinned-{frame:06d}.ply
  # posed_LBS_mesh_path: /mnt/home/fabianprada/Data/SociopticonProcessing/s--20210823--1323--0000000--pilot--patternCloth/shirt_tracking/small_pattern/kinematic_alignment/sequential_alignment_accel_0/{frame:06d}/optimum_skinned.ply
  # posed_LBS_mesh_path: /mnt/home/fabianprada/Data/SociopticonProcessing/s--20210823--1323--0000000--pilot--patternCloth/shirt_tracking/small_pattern/binocular_registration/projective_fitting_non_sequential/Meshes-04/skinned-{frame:06d}-400889-400926.ply
  posed_LBS_mesh_path: /mnt/home/fabianprada/Data/SociopticonProcessing/s--20210823--1323--0000000--pilot--patternCloth/shirt_tracking/small_pattern/kinematic_alignment/sequential_alignment_accel_0_lowRes/{frame:06d}/new_skinned.ply
  driving_camera_ids: [1, 3] #[1] #[2, 4, 5] #[1, 3] # indices indrivingCamsSelected - that was used to create the delta tensor
  deformer:
    LBO_path: /mnt/home/oshrihalimi/pycharm/cloth_completion/assets/LBO_eigenvectors_seamlessTextured.pt
    LBO_num: 200
    LBO_cutoff: 20 # 50
    LBO_scale: 35 # 20

  #ignore_masks_path: /mnt/home/donglaix/s--20210823--1323--0000000--pilot--patternCloth/lodstar_masks/{camera}_mask.png
  #background_path: ${raw_sequence_dir}/undistorted/cam{camera}/image12000.png

  image_height: 4096
  image_width: 2668
  image_ds_rate: 2

  # set dummy mean texture, not used for supervision
  tex_path: /mnt/home/oshrihalimi/Data/RenderingGeometry/texture_global.jpeg
  tex_mean_path: /mnt/home/oshrihalimi/Data/RenderingGeometry/texture_global.jpeg

training:
  tag: kinematic model_sequential_alignment_accel_0_lowRes_augmentation_cutoff_20_scale_35
  batch_size: 3
  num_epochs: 100000000000000
  num_max_iters: 400010000000000

#  pretrained_model:
#    strict: False
#    path: /mnt/home/oshrihalimi/cloth_completion/CodecOutput/cloth_driving_registration_2_cam_cleaned_input_sequence_16_unet_6_down_up_kinematic_model/checkpoints/050000.pt

  # TODO: should be there a smaller LR for pre-trained parts?
  optimizer:
    kind: 'default'
    class_name: torch.optim.AdamW
    config:
      lr: 1.0e-5

  # TODO: we can actually have different schedulers for different
  # parameters?
  lr_scheduler:
    class_name: torch.optim.lr_scheduler.MultiStepLR
    config:
      milestones: [1, 2, 3, 4, 5]
      gamma: 0.9

  update_lr_every: 4000

  log_every: 10
  summary_every: 10
  save_every: 2000
  val_every: 1000
  test_every: 80000

  # TODO: this should be
  num_workers: 4
  shuffle: True

  # where to store outputs
  output_dir: /mnt/home/oshrihalimi/cloth_completion/CodecOutput/${training.tag}
  verbose_logging: True

loss:
  class_name: ${module_prefix}.cloth_codec.TotalLoss
  config:
    weights:
      # only apply loss to clothes geometry
      clothes_geometry_laplacian: 0.0 #50.0
      clothes_geometry_rec: 0.5
      loss_clothes_normals_rec: 50
      clothes_tex_rec: 0.0
      kl: 1.0
